
cmake_minimum_required(VERSION 3.22)

set(MCU_NAME atmega32)

set(CMAKE_SYSTEM_NAME Generic)
set(CMAKE_C_COMPILER avr-gcc CACHE STRING "c compiler" FORCE)
set(CMAKE_CXX_COMPILER avr-g++ CACHE STRING "c++ compiler" FORCE)
set(CMAKE_OBJCOPY avr-objcopy CACHE STRING "avr-objcopy" FORCE)
set(CMAKE_C_FLAGS "-mmcu=${MCU_NAME} -Os -DF_CPU=16000000UL")
##################################################################################
project(ElevatorConrol)

file(GLOB_RECURSE SOURCES RELATIVE ${CMAKE_CURRENT_SOURCE_DIR} *.c *.h)

string(REGEX REPLACE "build/[^;]+;?" "" SOURCES "${SOURCES}")

add_subdirectory(MCAL/Dio)

add_executable(${PROJECT_NAME}.elf ${SOURCES})

#target_link_libraries(${PROJECT_NAME}.elf PUBLIC Dio)
target_include_directories(${PROJECT_NAME}.elf PUBLIC
    ${CMAKE_SOURCE_DIR}/Common
    ${CMAKE_SOURCE_DIR}/MCAL/Dio/include
    ${CMAKE_SOURCE_DIR}/MCAL/Dio/cfg
)


message("${FLASH_FLAGS}")

add_custom_target(flash ALL
    DEPENDS ${PROJECT_NAME}.elf
    COMMAND avr-objcopy -j .txt -j .data -O ihex ${PROJECT_NAME}.elf ${PROJECT_NAME}.hex)

add_custom_target(burn
    DEPENDS flash
    COMMAND avrdude -c usbasp -p m32 -B 1.0 -U flash:w:${PROJECT_NAME}.hex:a)